<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title>Trip Analyzer</title>
	<link rel="stylesheet" href="./css/style.css">
	<link rel="stylesheet" href="./css/jquery-ui.css">	
	<link rel="stylesheet" type="text/css" href="./css/zInput_default_stylesheet.css">
</head>
<body>
	<script src="./js/import/d3.v3.min.js"></script> 
	<script src="./js/import/topojson.v1.min.js"></script>  
	<script src="./js/import/datamaps.world.min.js?v=1"></script>
	<script src="./js/import/jquery-1.12.4.js"></script>
	<script src="./js/import/jquery-ui.js"></script>				
	<script src="./js/import/zInput.js"></script>			
	
	<div id="inputDialog" title="- Tell us more about the trip -">			
		<form>
			<fieldset style="height:280px;">
			
				<div>
					<label for="name" class="form-label">Budget</label>				
					<ul id="selectBudget" class="select-box">
						<li class="ui-widget-content" id="budget-low">Low</li>
						<li class="ui-widget-content" id="budget-mid">Mid</li>
						<li class="ui-widget-content" id="budget-high">High</li>
					</ol>
				</div>
				
				<div>
					<label for="name" class="form-label">Density</label>				
					<ul id="selectDensity" class="select-box">
						<li class="ui-widget-content" id="density-low">Low</li>
						<li class="ui-widget-content" id="density-mid">Mid</li>
						<li class="ui-widget-content" id="density-high">High</li>
					</ol>
				</div>
				
				<div>
					<label for="name" class="form-label">Trip Duration</label>				
					<input style="margin-left:50px;" type="text" id="tripDuartion" value="" >				
				</div>
								
				<div id="selectCategory">					
					<input type="checkbox" name="check[]" id="chkDiscovering" title="discovering">
					<input type="checkbox" name="check[]" id="chkEating" title="eating">
					<input type="checkbox" name="check[]" id="chkNightlife" title="nightlife">
					<input type="checkbox" name="check[]" id="chkOutdoors" title="outdoors">
					<input type="checkbox" name="check[]" id="chkFamily" title="family">
					<input type="checkbox" name="check[]" id="chkRelaxing" title="relaxing">
					<input type="checkbox" name="check[]" id="chkShopping" title="shopping">
					<input type="checkbox" name="check[]" id="chkSightseeing" title="sightseeing">
					<input type="checkbox" name="check[]" id="chkSports" title="sports">					
				</div>
								
				
				<input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
			</fieldset>
		</form>
	</div>
	
	<div id="divMain" style="text-align: center;" class="transparent">
		<div style="display: inline-block;">
			<div id="divContainer">
				<div id="divInput" class="main-div" style="display: none;">
					budget: <input type="text" name="budget" id="budget" value="">
					density: <input type="text" name="density" id="density" value="">
				</div>	
				<div id="divMap" class="main-div"></div>
				<div id="divBottom" class="main-div">
				
					<!-- Brian, please add mock up bottom chart here -->
				    <div class="chart">
								<svg width="300" height="200"></svg>
									<style>
									.bar {
												fill: rgb(95, 145, 187);
												}

												.bar:hover {
												fill: brown;
												}
									</style>
						</div>					
					<div class="chart">PM</div>
					
					<!-- reserved, can be deleted if no use -->					
		
					<div  class="chart" id='my-container'></div>								
					<div class="chart" id="divWordCloud"></div>
					
				</div>
				
				
				<div id="divRight" class="main-div">
				
					<!-- Youjung, please add top 10 / 15 / 20 accordion here -->								
				
				
				</div>
			</div>			
			<footer>&copy; Copyright 2019 Trip Analyzer</footer>
		</div>
	<div>

	
	<script src="./js/userInput.js"></script>	      
		  	 
	<script>		
	
		
	
		$( function() {			
			// initialize
			$("#selectBudget").selectable();
			$("#selectDensity").selectable();						
			$("#selectCategory").zInput();							
		});  													
		
		
		
		
		
				
	</script>
	
	
	
	<script> 
		
		// configurable constant weighting 
		// contains the weights of matching on different aspects
		// eg, matching user's budget input, score 10
		// matching user's density input, score 10
		// matching user's category preference, each poi of a city would score 0.1
		var weights = {budget: 30, density: 30, per_poi: 0.1};
		
		var bubbleArray = [];
		var cities;
		
		$.get("./include/fetch_recommendation.php", function(data){
			getAllCities(data);					
			analyze();			
		});

		// main method to analyze based on user input / default setting if user input isn't present
		function analyze(){
												
			// reset score
			resetScore();

			// recommendation system
			scoreBudget(document.getElementById("budget").value);						// budget matching						
			scoreDensity(document.getElementById("density").value);						// density matching			
			scoreCategory();
						
			// todo: add more filtering steps here
			// eg, reddit sentiment, to be added by Ankur 
			// eg, budget your trip, to be added by SiOnn			
			// --- end of recommendation system ---						
			
			sortByScore();					
			generateTop20Ranking();	
			console.log(cities); 	// testing console output
			
			addAccordions();
			addBubbles();			
			
		}			
		
		// fetch all data from database
		function getAllCities(data)
		{
			cities  = JSON.parse(data);
			// default score at 0
			for(i=0; i<cities.length; i++){				
				cities[i]["score"] = 0;	
				cities[i].rank = parseInt(cities[i].rank);		// type conversion	
				cities[i].lat = parseFloat(cities[i].lat);		// type conversion	
				cities[i].lng = parseFloat(cities[i].lng);		// type conversion	
			}						
		}		
		
		function resetScore(){
			for(i=0; i<cities.length; i++){				
				cities[i]["score"] = 0;				
			}
		}
		
		// calculate score based on user input budget
		function scoreBudget(budget){
			if (budget == "") return;
			for(i=0; i<cities.length; i++){							
				switch(budget) {
				  case "low":
					if (cities[i].receipts_rank == 1 || cities[i].receipts_rank == 2 || cities[i].receipts_rank == 0)		cities[i].score += weights.budget;
					continue;
				  case "mid":
					if (cities[i].receipts_rank == 2 || cities[i].receipts_rank == 3 || cities[i].receipts_rank == 0)		cities[i].score += weights.budget;
					continue;
				  case "high":
					if (cities[i].receipts_rank == 3 || cities[i].receipts_rank == 4 || cities[i].receipts_rank == 0)		cities[i].score += weights.budget;										
					continue;
				}							
			}							
		}
		
		// calculate score based on user input density
		function scoreDensity(density){
			if (density == "") return;
			for(i=0; i<cities.length; i++){							
				switch(density) {
				  case "low":
					if (cities[i].arrivals_rank == 1 || cities[i].arrivals_rank == 2 || cities[i].arrivals_rank == 0)		cities[i].score += weights.density;									  				
					continue;
				  case "mid":
					if (cities[i].arrivals_rank == 2 || cities[i].arrivals_rank == 3 || cities[i].arrivals_rank == 0)		cities[i].score += weights.density;										
					continue;
				  case "high":
					if (cities[i].arrivals_rank == 3 || cities[i].arrivals_rank == 4 || cities[i].arrivals_rank == 0)		cities[i].score += weights.density;										
					continue;
				}							
			}							
		}		
		
		// calculate score based on user input selected category
		function scoreCategory(){			
			for(i=0; i<cities.length; i++){									
				if ($('#chkDiscovering').parent().parent().parent().hasClass('zSelected'))	cities[i].score += cities[i].discovering * weights.per_poi;
				if ($('#chkEating').parent().parent().parent().hasClass('zSelected'))		cities[i].score += cities[i].eating * weights.per_poi;				
				if ($('#chkNightlife').parent().parent().parent().hasClass('zSelected'))	cities[i].score += cities[i].nightlife * weights.per_poi;
				if ($('#chkOutdoors').parent().parent().parent().hasClass('zSelected'))		cities[i].score += cities[i].hiking * weights.per_poi;
				if ($('#chkFamily').parent().parent().parent().hasClass('zSelected'))		cities[i].score += cities[i].family * weights.per_poi;
				if ($('#chkRelaxing').parent().parent().parent().hasClass('zSelected'))		cities[i].score += cities[i].relaxing * weights.per_poi;
				if ($('#chkShopping').parent().parent().parent().hasClass('zSelected'))		cities[i].score += cities[i].shopping * weights.per_poi;
				if ($('#chkSightseeing').parent().parent().parent().hasClass('zSelected'))	cities[i].score += cities[i].sightseeing * weights.per_poi;
				if ($('#chkSports').parent().parent().parent().hasClass('zSelected'))		cities[i].score += cities[i].sports * weights.per_poi;
			}								
		}				
		
		// push sorted cities into bubbleArray for UI
		function generateTop20Ranking(){						
			for (i = 0; i < 20; i++){
				var bubble = { name: cities[i].city, latitude: cities[i].lat, longitude: cities[i].lng, radius: 50-i*2, fillKey: 'colorRank'+i};
				bubbleArray.push(bubble);								
			};									
		}
		
		// sort cities by score then default rank from top 100
		function sortByScore(){			
			cities.sort(function(a,b){				
				if (a.score > b.score)		{	return -1;	}
				else if (a.score < b.score)	{	return 1;	}
				else {
					if (a.rank < b.rank)		{	return -1;	}
					else if (a.rank > b.rank)	{	return 1;	}
				}													
			});						
		}					
		
		// testing method: print text to right section 
		function addAccordions(){		
			document.getElementById('divRight').innerHTML = '';
			for (i = 0; i < 20; i++) {
				document.getElementById('divRight').innerHTML += cities[i].city + '<br/>';						
			}
		}
		
	</script>		

	<!----  add by Brian-->
	<!---   script language="JavaScript" type="text/javascript" src="js/jquery-1.12.4.js"></script> -->
	<script  type="text/javascript"  charset="utf-8">  
		(function(w,d,t,f){  w[f]=w[f]||function(c,k,n){s=w[f],k=s['k']=(s['k']||(k?('&k='+k):''));s['c']=  
		c=(c  instanceof  Array)?c:[c];s['n']=n=n||0;L=d.createElement(t),e=d.getElementsByTagName(t)[0];  
		L.async=1;L.src='http://feed.aqicn.org/feed/'+(c[n].city)+'/'+(c[n].lang||'')+'/feed.v1.js?n='+n+k;  
		e.parentNode.insertBefore(L,e);  };  })(  window,document,'script','_aqiFeed'  );    
</script>
<script>
function createbar(country){

	var svg = d3.select("svg"),
	margin = {
		top: 50,
		right: 20,
		bottom: 30,
		left: 50
	},
	width = +svg.attr("width") - margin.left - margin.right,
	height = +svg.attr("height") - margin.top - margin.bottom,
	g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var parseTime = d3.timeParse("%d-%b-%y");

	var x = d3.scaleBand()
		.rangeRound([0, width])
		.padding(0.1);

	var y = d3.scaleLinear()
		.rangeRound([height, 0]);

	/*var country='CAN' */
	d3.csv("world_temp.csv").then(function (data) {
		var mintemp = d3.min(data, function (d) {
					return +d[country]});
		var mintemp = (mintemp > 0) ? 0 : mintemp - 2;
		x.domain(data.map(function (d) {
				return d.countrycode;
			}));
		y.domain([	mintemp , 
					d3.max(data, function (d) {
					return +d[country];})
				]);

		g.append("g")
		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x))

		g.append("g")
		.call(d3.axisLeft(y))
		.append("text")
		.attr("fill", "#000")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", "0.71em")
		.attr("text-anchor", "end")
		.text("Temperature");

		g.append("g")
		.append("text")
		.attr("x",function(d){return (width / 2) + margin.left;})
		.attr("y", -10)
		.attr("text-anchor", "end")
		.text("Temperature of " + country);

		g.selectAll(".bar")
		.data(data)
		.enter().append("rect")
		.attr("class", "bar")
		.attr("x", function (d) {
			return x(d.countrycode);
		})
		.attr("y", function (d) {
			return y(Number(d[country]));
		})
		.attr("width", x.bandwidth())
		.attr("height", function (d) {
			return height - y(Number(d[country]));
		});
	});
}
</script>


	<script src="./js/dataMap.js"></script>			
	
	<script> 
		$(document).on("click",".datamaps-bubble", function () {			
			document.getElementById("divWordCloud").innerHTML = "";
			var info = $(this).attr('data-info'); // or var clickedBtnID = this.id
			json = JSON.parse(info);			
			var elem = document.createElement("img");
			elem.src = "wordcloud/" + json["name"].toLowerCase() + ".png";								
			elem.style.width = '100%';			
			elem.style.height = '100%';	
			document.getElementById("divWordCloud").appendChild(elem);
			
			_aqiFeed({  city: json["name"].toLowerCase()   ,  lang:"en",  callback:function(aqi){  
								$("#my-container").html(aqi.details);  
							}  });  
			createbar('CAN');
		});
	</script>
	


	
			
	
</body>

